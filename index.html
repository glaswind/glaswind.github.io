<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ù–æ–≤–æ–≥–æ–¥–Ω—è—è –∫–æ–ø–∏–ª–∫–∞</title>
  <style>
    /* --- New Year design --- */
    :root{--bg:#08121a;--card:#06232d;--accent:#ffd166;--glass:rgba(255,255,255,0.06)}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, Arial, sans-serif;background:linear-gradient(180deg,#031018 0%, #032431 60%);color:#fff}
    .scene{min-height:100%;display:flex;align-items:center;justify-content:center;padding:32px}
    .card{width:420px;max-width:95%;background:linear-gradient(180deg,rgba(255,255,255,0.03), rgba(255,255,255,0.01));border-radius:18px;padding:22px;box-shadow:0 8px 30px rgba(2,6,23,0.7);border:1px solid rgba(255,255,255,0.03);position:relative;overflow:hidden}
    h1{margin:0 0 6px;font-size:20px;letter-spacing:0.6px}
    .subtitle{font-size:12px;color:#bfe8ff;margin-bottom:18px}
    .amount{font-size:40px;font-weight:700;margin:10px 0;display:flex;align-items:flex-end;gap:10px}
    .currency{font-size:18px;opacity:0.9}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    button{background:linear-gradient(180deg,var(--accent),#ffb84d);border:0;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;box-shadow:0 6px 18px rgba(255,160,40,0.18)}
    .btn-sec{background:transparent;border:1px solid rgba(255,255,255,0.08);padding:8px 12px;border-radius:10px;color:#dff6ff}
    input[type=number]{width:120px;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff}
    .small{font-size:13px;color:#cbeffd;margin-top:12px}

    /* decorative santa tree */
    .tree{position:absolute;right:-60px;bottom:-80px;transform:rotate(12deg);opacity:0.16;width:380px}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:14px}
    .link{font-size:12px;color:#cbeffd;opacity:0.85}

    /* snow animation */
    .snow{pointer-events:none;position:absolute;inset:0;z-index:0}
    .flake{position:absolute;top:-10px;width:8px;height:8px;border-radius:50%;background:white;opacity:0.9;filter:blur(0.6px)}

    /* modal */
    .overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.75));display:flex;align-items:center;justify-content:center}
    .modal{background:var(--card);padding:20px;border-radius:12px;width:360px;box-shadow:0 10px 40px rgba(0,0,0,0.7)}
    .row{display:flex;gap:8px;align-items:center;margin-top:10px}
    .danger{background:#ff6b6b}

    /* small helpers */
    .muted{opacity:0.75;font-size:13px}

    @media (max-width:420px){.card{padding:16px}}
  </style>
</head>
<body>
  <div class="scene">
    <div class="card" id="app" aria-live="polite">
      <h1>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω—è—è –∫–æ–ø–∏–ª–∫–∞</h1>
      <div class="subtitle">–õ–∏—á–Ω–∞—è –∫–æ–ø–∏–ª–∫–∞ ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–±—è. –î–µ–Ω—å–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</div>

      <div class="amount" id="amountDisplay"><span id="amountValue">0</span><span class="currency">‚Ç¥</span></div>

      <div class="controls">
        <button id="add100">+100</button>
        <button id="sub100" class="btn-sec">‚àí100</button>
        <input type="number" id="customInput" placeholder="–°—É–º–º–∞" />
        <button id="addCustom" class="btn-sec">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button id="subCustom" class="btn-sec">–°–Ω—è—Ç—å</button>
      </div>

      <div class="small">–ë–∞–ª–∞–Ω—Å –∏ –∏—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é.</div>

      <div class="footer">
        <div class="muted">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: <span id="lastChange">‚Äî</span></div>
        <div>
          <button id="export" class="btn-sec">–≠–∫—Å–ø–æ—Ä—Ç</button>
          <button id="reset" class="btn-sec danger">–°–±—Ä–æ—Å</button>
        </div>
      </div>

      <svg class="tree" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
        <g>
          <ellipse cx="100" cy="180" rx="50" ry="8" fill="#0b3a2b" opacity="0.3"/>
          <path d="M100 12 L60 90 L140 90 Z" fill="#0f7b4f"/>
          <path d="M100 50 L50 140 L150 140 Z" fill="#0f8f5e"/>
          <path d="M100 90 L40 180 L160 180 Z" fill="#0fb071"/>
          <rect x="88" y="180" width="24" height="18" rx="4" fill="#67402a"/>
        </g>
      </svg>

      <div class="snow" id="snow"></div>
    </div>
  </div>

  <!-- modal templates -->
  <template id="setPinTpl">
    <div class="overlay" id="setPinModal">
      <div class="modal">
        <h3>–ù–∞—Å—Ç—Ä–æ–π PIN</h3>
        <div class="subtitle">–£—Å—Ç–∞–Ω–æ–≤–∏ PIN ‚Äî —Ç–æ–ª—å–∫–æ —Å –Ω–∏–º –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –∫–æ–ø–∏–ª–∫—É –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.</div>
        <div class="row"><input id="newPin" type="password" placeholder="–ù–æ–≤—ã–π PIN (4-8 —Ü–∏—Ñ—Ä)" /></div>
        <div class="row"><input id="newPin2" type="password" placeholder="–ü–æ–≤—Ç–æ—Ä PIN" /></div>
        <div class="row"><button id="savePin">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å PIN</button><button id="skipPin" class="btn-sec">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button></div>
        <div class="small">PIN —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ —Ö–µ—à –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. –≠—Ç–æ –Ω–µ –∞–±—Å–æ–ª—é—Ç–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚Äî —Å–ª—É–∂–∏—Ç –¥–ª—è –ª–∏—á–Ω–æ–≥–æ —É–¥–æ–±—Å—Ç–≤–∞.</div>
      </div>
    </div>
  </template>

  <template id="enterPinTpl">
    <div class="overlay" id="enterPinModal">
      <div class="modal">
        <h3>–í–≤–µ–¥–∏—Ç–µ PIN</h3>
        <div class="row"><input id="pinInput" type="password" placeholder="PIN" /></div>
        <div class="row"><button id="unlockBtn">–û—Ç–∫—Ä—ã—Ç—å</button><button id="forgotBtn" class="btn-sec">–ó–∞–±—ã–ª–∏ PIN?</button></div>
        <div class="small">–ï—Å–ª–∏ –∑–∞–±—É–¥–µ—à—å PIN ‚Äî –º–æ–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –∫–æ–ø–∏–ª–∫—É (—É–¥–∞–ª–∏—Ç –±–∞–ª–∞–Ω—Å –∏ PIN).</div>
      </div>
    </div>
  </template>

  <script>
    // Simple local piggy-bank app. Data stored in localStorage under keys:
    // piggy_amount (number), piggy_history (array), piggy_pin_hash (hex)

    const K_AMOUNT = 'piggy_amount_v1';
    const K_HISTORY = 'piggy_history_v1';
    const K_PIN = 'piggy_pin_hash_v1';

    // helpers
    const $ = id => document.getElementById(id);
    function formatAmount(n){return Number(n).toLocaleString('ru-RU')}
    function nowISO(){ return new Date().toISOString() }

    async function hashPin(pin){
      const enc = new TextEncoder().encode(pin);
      const digest = await crypto.subtle.digest('SHA-256', enc);
      const arr = Array.from(new Uint8Array(digest));
      return arr.map(b => b.toString(16).padStart(2,'0')).join('');
    }

    // PIN flow
    function showTemplate(tpl){
      const node = tpl.content.cloneNode(true);
      document.body.appendChild(node);
    }

    async function requireUnlock(){
      const stored = localStorage.getItem(K_PIN);
      if(!stored){
        // set PIN
        showTemplate($('setPinTpl'));
        $('savePin').onclick = async ()=>{
          const a = $('newPin').value.trim();
          const b = $('newPin2').value.trim();
          if(!/^[0-9]{4,8}$/.test(a)){alert('PIN –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 4-8 —Ü–∏—Ñ—Ä');return}
          if(a!==b){alert('PIN –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç');return}
          const h = await hashPin(a);
          localStorage.setItem(K_PIN, h);
          document.getElementById('setPinModal').remove();
          showApp();
        };
        $('skipPin').onclick = ()=>{document.getElementById('setPinModal').remove();showApp()};
      } else {
        // ask PIN
        showTemplate($('enterPinTpl'));
        $('unlockBtn').onclick = async ()=>{
          const p = $('pinInput').value.trim();
          const h = await hashPin(p);
          if(h === localStorage.getItem(K_PIN)){
            document.getElementById('enterPinModal').remove();
            showApp();
          } else alert('–ù–µ–≤–µ—Ä–Ω—ã–π PIN');
        };
        $('forgotBtn').onclick = ()=>{
          if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –∫–æ–ø–∏–ª–∫—É –∏ PIN? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ.')){
            localStorage.removeItem(K_PIN);localStorage.removeItem(K_AMOUNT);localStorage.removeItem(K_HISTORY);
            document.getElementById('enterPinModal').remove();
            // start fresh
            requireUnlock();
          }
        };
      }
    }

    // main logic
    function readAmount(){return Number(localStorage.getItem(K_AMOUNT) || 0)}
    function writeAmount(n){localStorage.setItem(K_AMOUNT, String(n))}
    function readHistory(){try{return JSON.parse(localStorage.getItem(K_HISTORY) || '[]')}catch(e){return []}}
    function writeHistory(h){localStorage.setItem(K_HISTORY, JSON.stringify(h))}

    function pushHistory(type, delta, before, after){
      const h = readHistory();
      h.unshift({t: nowISO(), type, delta, before, after});
      if(h.length>200) h.pop();
      writeHistory(h);
      $('lastChange').textContent = (new Date()).toLocaleString();
    }

    function updateUI(){
      $('amountValue').textContent = formatAmount(readAmount());
    }

    function changeBy(delta){
      const before = readAmount();
      const after = Math.round((before + delta)*100)/100;
      writeAmount(after);
      pushHistory(delta>0? 'add' :'sub', delta, before, after);
      updateUI();
    }

    function showApp(){
      updateUI();
      $('add100').onclick = ()=>changeBy(100);
      $('sub100').onclick = ()=>changeBy(-100);
      $('addCustom').onclick = ()=>{
        const v = Number($('customInput').value || 0); if(!v){alert('–í–≤–µ–¥–∏ —Å—É–º–º—É');return} changeBy(Math.abs(v)); $('customInput').value='';
      };
      $('subCustom').onclick = ()=>{
        const v = Number($('customInput').value || 0); if(!v){alert('–í–≤–µ–¥–∏ —Å—É–º–º—É');return} changeBy(-Math.abs(v)); $('customInput').value='';
      };

      $('export').onclick = ()=>{
        const data = {amount: readAmount(), history: readHistory(), exportedAt: nowISO()};
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='kopilka_backup_'+(new Date()).toISOString()+'.json'; a.click(); URL.revokeObjectURL(url);
      };

      $('reset').onclick = ()=>{
        if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –±–∞–ª–∞–Ω—Å –∏ PIN? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ.')){
          localStorage.removeItem(K_AMOUNT); localStorage.removeItem(K_HISTORY); localStorage.removeItem(K_PIN);
          location.reload();
        }
      };

      // show last change
      const hist = readHistory(); if(hist.length) $('lastChange').textContent = (new Date(hist[0].t)).toLocaleString(); else $('lastChange').textContent='‚Äî';

      // unlock UI elements (they are visible but blocked until PIN entered)
    }

    // init snow
    function makeSnow(){
      const container = $('snow');
      for(let i=0;i<25;i++){const s=document.createElement('div');s.className='flake';s.style.left=(Math.random()*100)+'%';s.style.opacity=0.6+Math.random()*0.6;const size=4+Math.random()*8;s.style.width=size+'px';s.style.height=size+'px';s.style.animationDuration=(6+Math.random()*8)+'s';s.style.transform='translateY(0)';container.appendChild(s);
        const dur=6+Math.random()*8; s.animate([
          {transform:'translateY(-10vh) translateX(0)', opacity: s.style.opacity},
          {transform:'translateY(120vh) translateX(30vw)', opacity:0.6}
        ],{duration: (dur*1000), iterations: Infinity, delay: Math.random()*-6000});
      }
    }

    // start
    (function(){
      makeSnow();
      requireUnlock();
    })();
  </script>
</body>
</html>
